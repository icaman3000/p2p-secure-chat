# P2P Secure Chat

一个安全的点对点聊天应用，支持多设备同步、离线消息和端到端加密。

## 功能特点

- 点对点通信
  - 本地连接优先
  - STUN 服务器辅助穿透 NAT
  - 无需中心服务器中转

- 多设备同步
  - 设备自动发现
  - 增量数据同步
  - 离线消息同步
  - 好友列表同步

- 安全性
  - 端到端加密
  - 设备认证
  - 消息完整性验证

- 用户友好
  - 现代化 UI 界面
  - 好友管理系统
  - 离线消息提醒
  - 实时消息通知

## 技术实现

### 多设备同步机制

1. 设备发现
   - 新设备登录时广播设备发现消息
   - 同一用户的其他在线设备响应发现请求
   - 使用设备 ID 和用户 ID 进行身份验证

2. 数据同步
   - 增量同步策略
   - 支持好友列表同步
   - 支持历史消息同步
   - 支持离线消息同步

3. 同步流程
   ```
   新设备登录
   ↓
   广播设备发现
   ↓
   收到其他设备响应
   ↓
   发送同步请求
   ↓
   接收同步数据
   ↓
   更新本地数据库
   ```

4. 备用同步方案
   - 当没有其他设备在线时
   - 从好友节点获取数据
   - 确保数据一致性

## 系统要求

- Python 3.8+
- 支持的操作系统：
  - Windows 10/11
  - macOS 10.15+
  - Linux (主流发行版)

## 安装说明

1. 克隆仓库
```bash
git clone https://github.com/yourusername/p2p-secure-chat.git
cd p2p-secure-chat
```

2. 安装依赖
```bash
poetry install
```

3. 运行应用
```bash
poetry run python src/main.py
```

## 使用说明

1. 注册/登录
   - 首次使用需要注册账号
   - 使用用户名和密码登录
   - 登录后自动进行设备注册
   - 支持最多两个设备同时在线
     - 同一账号最多可以在两个设备上同时登录
     - 尝试在第三个设备登录时会被拒绝
     - 需要先从其他设备登出才能在新设备上登录
     - 所有在线设备都会收到实时消息
     - 设备之间自动同步数据
     - 可以在设备管理中查看当前在线设备

2. 添加好友
   - 输入好友的用户 ID
   - 发送好友请求
   - 等待对方接受

3. 聊天功能
   - 支持文本消息
   - 支持特殊字符
   - 支持大文件传输
   - 支持并发消息

4. 多设备使用
   - 在新设备上登录已有账号
   - 系统自动发现同一账号的其他在线设备
   - 自动从在线设备同步数据
   - 如果没有在线设备，则从好友节点获取数据
   - 所有设备上的消息和好友列表保持同步
   - 任何设备上的操作都会同步到其他设备
   - 支持查看和管理当前登录的所有设备

### 设备管理
- 可以查看当前账号登录的所有设备（最多两个）
- 显示每个设备的最后同步时间
- 支持手动触发数据同步
- 可以远程登出其他设备
- 查看设备在线状态
- 设备数量限制
  - 每个账号最多支持两个设备同时在线
  - 超出限制时需要先登出其他设备
  - 可以手动停用不再使用的设备
  - 支持远程停用设备

## 开发说明

### 项目结构
```